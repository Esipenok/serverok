# Система уведомлений One Night

## Обзор

Система уведомлений для приглашений на "одну ночь" работает аналогично системе уведомлений лайков. Она отслеживает количество приглашений и автоматически управляет счетчиками.

## Тип уведомления

- **Тип**: `one_night_counter`
- **Счетчик**: `oneNightCount`

## Методы API

### 1. sendOneNightNotification(targetUserId)

Отправляет уведомление о приглашении на одну ночь.

**Параметры:**
- `targetUserId` (string) - ID пользователя, которому отправляется уведомление

**Логика:**
- Если уведомление типа `one_night_counter` уже существует - увеличивает счетчик на 1
- Если уведомления нет - создает новое с счетчиком = 1
- Обновляет заголовок и текст в зависимости от количества

**Пример использования:**
```javascript
const notificationService = require('./notifications/notification.service');
await notificationService.sendOneNightNotification('user123');
```

### 2. decrementOneNightCounter(userId)

Уменьшает счетчик приглашений на одну ночь.

**Параметры:**
- `userId` (string) - ID пользователя, у которого нужно уменьшить счетчик

**Логика:**
- Уменьшает счетчик на 1
- Если счетчик становится 0 или меньше - удаляет уведомление
- Если счетчик больше 0 - обновляет уведомление с новым значением

**Пример использования:**
```javascript
const notificationService = require('./notifications/notification.service');
await notificationService.decrementOneNightCounter('user123');
```

## Интеграция с One Night контроллером

### Создание приглашения (`createInvitation`)

```javascript
// После создания приглашения
await notificationService.sendOneNightNotification(userId2);
```

### Ответ на приглашение (`handleResponse`)

```javascript
// После обработки ответа (принятие или отказ)
await notificationService.decrementOneNightCounter(userId2);
```

### Отмена приглашения (`deleteInvitation`)

```javascript
// При отмене приглашения
await notificationService.decrementOneNightCounter(userId2);
```

## Структура уведомления

```json
{
  "type": "one_night_counter",
  "title": "Новое приглашение!",
  "body": "Кто-то пригласил вас на одну ночь",
  "data": {
    "oneNightCount": 3,
    "timestamp": 1640995200000
  },
  "timestamp": 1640995200000,
  "read": false
}
```

## Сценарии использования

### 1. Новое приглашение
- Пользователь 1 приглашает пользователя 2
- Система отправляет уведомление пользователю 2
- Счетчик увеличивается на 1

### 2. Принятие приглашения
- Пользователь 2 принимает приглашение
- Система уменьшает счетчик на 1
- Если счетчик становится 0 - уведомление удаляется

### 3. Отказ от приглашения
- Пользователь 2 отказывается от приглашения
- Система уменьшает счетчик на 1
- Если счетчик становится 0 - уведомление удаляется

### 4. Отмена приглашения
- Пользователь 1 отменяет приглашение
- Система уменьшает счетчик на 1
- Если счетчик становится 0 - уведомление удаляется

## Тестирование

Для тестирования системы используйте файл `tests/test-one-night-notification.js`:

```bash
node tests/test-one-night-notification.js
```

## Обработка ошибок

Все методы уведомлений обрабатывают ошибки gracefully:
- Ошибки логируются в консоль
- Основная логика приложения продолжает работать
- Уведомления не блокируют основной функционал

## Firebase структура

Уведомления сохраняются в Firebase Realtime Database по пути:
```
/notifications/{userId}/{notificationId}
```

Где:
- `{userId}` - ID пользователя
- `{notificationId}` - автоматически генерируемый ID уведомления 