# Улучшения безопасности JWT

В этом документе описаны улучшения безопасности JWT-токенов, реализованные в проекте.

## 1. Проверка IP-адреса в токене

### Что это такое?
При генерации JWT-токена в него добавляется IP-адрес клиента. При каждом запросе с этим токеном проверяется, совпадает ли текущий IP-адрес клиента с тем, который был сохранен в токене.

### Зачем это нужно?
Это защищает от атак с использованием украденных токенов. Даже если злоумышленник украдет токен, он не сможет использовать его с другого IP-адреса.

### Как это реализовано?
- В `token.service.js` добавлена функция `addIpToPayload`, которая добавляет IP-адрес в полезную нагрузку токена
- В `jwt.utils.js` функция `generateToken` теперь принимает IP-адрес и использует его
- В `auth.controller.js` все функции генерации токенов получают IP-адрес из запроса
- В `token.service.js` функция `verifyTokenWithSecurity` проверяет соответствие IP-адреса

## 2. Черный список отозванных токенов

### Что это такое?
Система хранит информацию о токенах, которые были отозваны (например, при выходе пользователя из системы) и отклоняет запросы с такими токенами.

### Зачем это нужно?
Это позволяет немедленно отозвать доступ пользователя при выходе из системы или при компрометации учетной записи, не дожидаясь истечения срока действия токена.

### Как это реализовано?
- Создана модель `BlacklistedToken` для хранения отозванных токенов
- В `token.service.js` добавлены функции `blacklistToken` и `isTokenBlacklisted`
- В `jwt.utils.js` добавлена функция `revokeToken`
- В `auth.controller.js` функция `logout` теперь добавляет токен в черный список
- В `token.service.js` функция `verifyTokenWithSecurity` проверяет, не находится ли токен в черном списке

## 3. Автоматическая очистка устаревших токенов

### Что это такое?
Система периодически удаляет из черного списка токены, срок действия которых уже истек, чтобы не перегружать базу данных.

### Зачем это нужно?
Это предотвращает бесконечный рост базы данных и улучшает производительность.

### Как это реализовано?
- В `token.service.js` добавлена функция `cleanupBlacklistedTokens`
- В `cleanup.js` добавлена функция `startTokenCleanup`, которая запускает периодическую очистку
- В `server.js` вызывается `startTokenCleanup` при запуске сервера

## Настройка

Для правильной работы системы необходимо добавить следующие переменные окружения в файл `.env`:

```
JWT_SECRET=your_super_secure_secret_key_change_this_in_production
JWT_EXPIRES_IN=24h
REFRESH_TOKEN_EXPIRES_IN=7d
TOKEN_CLEANUP_INTERVAL=60
```

где:
- `JWT_SECRET` - секретный ключ для подписи JWT-токенов
- `JWT_EXPIRES_IN` - время жизни обычного токена (например, "24h" для 24 часов)
- `REFRESH_TOKEN_EXPIRES_IN` - время жизни refresh-токена (например, "7d" для 7 дней)
- `TOKEN_CLEANUP_INTERVAL` - интервал очистки устаревших токенов в минутах 