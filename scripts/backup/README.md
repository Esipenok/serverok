# Скрипты для резервного копирования и восстановления

В этой директории находятся скрипты для управления резервными копиями API-сервера.

## Создание резервной копии

Для создания резервной копии используйте скрипт `create_backup.ps1`:

```powershell
.\create_backup.ps1
```

Скрипт создаст резервную копию текущего состояния сервера в директории `backups` на сервере. Имя резервной копии будет содержать текущую дату и время.

## Восстановление из резервной копии

Для восстановления из резервной копии используйте скрипт `restore_backup.ps1`:

```powershell
.\restore_backup.ps1 [имя_бэкапа]
```

Если имя бэкапа не указано, будет использован последний доступный бэкап.

Скрипт выполнит следующие действия:
1. Остановит контейнеры Docker
2. Сохранит важные файлы (.env, uploads, logs)
3. Удалит текущие файлы проекта
4. Восстановит файлы из бэкапа
5. Восстановит сохраненные файлы
6. Установит зависимости
7. Запустит контейнеры Docker
8. Проверит работоспособность API

## Просмотр доступных резервных копий

Для просмотра списка доступных резервных копий используйте скрипт `list_backups.ps1`:

```powershell
.\list_backups.ps1
```

Скрипт выведет список всех доступных резервных копий на сервере.

## Примечания

- Все скрипты требуют наличия SSH-ключа для подключения к серверу.
- Резервные копии хранятся в директории `backups` на сервере.
- Перед восстановлением рекомендуется создать резервную копию текущего состояния сервера.

## Процесс восстановления

При восстановлении из бэкапа выполняются следующие действия:

1. Останавливаются все контейнеры Docker
2. Сохраняются важные файлы и директории (node_modules, .env, uploads, logs, backups, ssl)
3. Очищается директория проекта
4. Восстанавливаются файлы из бэкапа
5. Восстанавливаются сохраненные файлы и директории
6. Запускаются контейнеры Docker
7. Проверяется работоспособность API

## Решение проблем

Если при запуске скрипта восстановления возникает ошибка:

1. Убедитесь, что вы запускаете скрипт из директории `scripts/backup`
2. Проверьте, что на сервере существует директория `backups` с резервными копиями
3. Если в скрипте возникает ошибка с кодировкой (символы `\r`), используйте команду:
   ```bash
   dos2unix restore_server.sh
   ```
   на сервере перед запуском скрипта восстановления

## Важные замечания

- Бэкапы хранятся на сервере в директории `/root/app/backups/`
- Автоматические бэкапы создаются при каждом деплое и имеют формат имени `backup_YYYYMMDD_HHMMSS`
- Ручные бэкапы, созданные с помощью скрипта `create_backup.ps1`, имеют формат имени `manual_backup_YYYYMMDD_HHMMSS` или пользовательское имя
- При автоматическом деплое сохраняются только 5 последних бэкапов, остальные удаляются
- Ручные бэкапы не удаляются автоматически 