name: Zero-Downtime Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::SSH_PRIVATE_KEY —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::SSH_USER —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "::error::SERVER_IP —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_PATH }}" ]; then
            echo "::error::SERVER_PATH —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
      - name: Create deployment archive
        run: |
          echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è zero-downtime deployment..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ä—Ö–∏–≤–∞
          mkdir -p temp_deploy
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
          cp -r app.js server.js package.json package-lock.json temp_deploy/
          cp -r auth config users matches fast_match marketprofiles qr complain one_night filter_* temp_deploy/ 2>/dev/null || true
          cp -r invites delete_all_data country utils temp_deploy/ 2>/dev/null || true
          cp -r security scripts docs temp_deploy/ 2>/dev/null || true
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          cd temp_deploy
          tar -czf ../server_update.tar.gz .
          cd ..
          
          echo "üìä –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
          ls -lh server_update.tar.gz
          
      - name: Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"
          
      - name: Copy files to server
        run: |
          echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -o StrictHostKeyChecking=no server_update.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/app/
          
      - name: Execute zero-downtime deployment (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ API)
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ zero-downtime deployment (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ API)..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "cd /app && bash zero_downtime_deploy_no_api_check.sh"
          
      - name: Deployment Summary (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ API)
        run: |
          echo "üéâ Zero-downtime deployment –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "üìÖ –î–∞—Ç–∞: $(date)"
          echo "‚ö†Ô∏è  API –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é"
          echo "üîó API: https://willowe.love/api/health"
          echo "üìä –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è: 0 —Å–µ–∫—É–Ω–¥"
          
      - name: Cleanup
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          rm -f server_update.tar.gz
          rm -rf temp_deploy 