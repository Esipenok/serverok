name: Zero-Downtime Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::SSH_PRIVATE_KEY —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::SSH_USER —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "::error::SERVER_IP —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_PATH }}" ]; then
            echo "::error::SERVER_PATH —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
      - name: Create deployment archive
        run: |
          echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è zero-downtime deployment..."
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Ç–æ–ª—å–∫–æ —Å –∫–æ–¥–æ–º (–±–µ–∑ node_modules, uploads, logs)
          tar --exclude='node_modules' \
              --exclude='uploads' \
              --exclude='logs' \
              --exclude='backups' \
              --exclude='ssl' \
              --exclude='.git' \
              --exclude='*.tar.gz' \
              --exclude='*.log' \
              -czf server_update.tar.gz .
          
          echo "üìä –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
          ls -lh server_update.tar.gz
          
      - name: Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"
          
      - name: Copy files to server
        run: |
          echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -o StrictHostKeyChecking=no server_update.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.SERVER_PATH }}/
          
      - name: Execute zero-downtime deployment
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ zero-downtime deployment..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "cd ${{ secrets.SERVER_PATH }} && bash zero_downtime_deploy.sh"
          
      - name: Verify deployment
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ deployment..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º API
          API_RESPONSE=$(curl -s -L https://willowe.love/api/health || echo "FAIL")
          if [[ "$API_RESPONSE" == *"success"* ]]; then
            echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          else
            echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          fi
          
      - name: Cleanup
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          rm -f server_update.tar.gz
          
      - name: Deployment Summary
        run: |
          echo "üéâ Zero-downtime deployment –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üìÖ –î–∞—Ç–∞: $(date)"
          echo "üîó API: https://willowe.love/api/health"
          echo "üìä –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è: 0 —Å–µ–∫—É–Ω–¥" 