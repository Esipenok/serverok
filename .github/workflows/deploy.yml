name: Zero-Downtime Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::SSH_PRIVATE_KEY —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::SSH_USER —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "::error::SERVER_IP —Å–µ–∫—Ä–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
      - name: Create deployment archive
        run: |
          echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è deployment..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ä—Ö–∏–≤–∞
          mkdir -p temp_deploy
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–∞–ø–∫—É src, –∏—Å–∫–ª—é—á–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          cp -r src temp_deploy/
          
          # –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞—Å—Ç—å –≤ –∞—Ä—Ö–∏–≤
          cd temp_deploy/src
          rm -rf node_modules logs backups infrastructure/uploads infrastructure/ssl
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          cd ../..
          tar -czf server_update.tar.gz -C temp_deploy .
          
          echo "üìä –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
          ls -lh server_update.tar.gz
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:"
          tar -tzf server_update.tar.gz | head -20
          
      - name: Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"
          
      - name: Copy files to server
        run: |
          echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          scp -o StrictHostKeyChecking=no server_update.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/root/app/
          
      - name: Execute zero-downtime deployment
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ zero-downtime deployment..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "cd /root/app && bash zero_downtime_deploy.sh"
          
      - name: Verify deployment
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ deployment..."
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
          API_RESPONSE=$(curl -s -L https://willowe.love/api/health || echo "FAIL")
          if [[ "$API_RESPONSE" == *"success"* ]] || [[ "$API_RESPONSE" == *"ok"* ]]; then
            echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          else
            echo "‚ùå –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∫—É
          ADMIN_RESPONSE=$(curl -s -L http://${{ secrets.SERVER_IP }}:3001 || echo "FAIL")
          if [[ "$ADMIN_RESPONSE" != "FAIL" ]]; then
            echo "‚úÖ –ê–¥–º–∏–Ω–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
          else
            echo "‚ùå –ê–¥–º–∏–Ω–∫–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          fi
          
      - name: Cleanup
        run: |
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          rm -f server_update.tar.gz
          rm -rf temp_deploy
          
      - name: Deployment Summary
        run: |
          echo "üéâ Deployment –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üìÖ –î–∞—Ç–∞: $(date)"
          echo "üîó API: https://willowe.love/api/health"
          echo "üîó –ê–¥–º–∏–Ω–∫–∞: http://${{ secrets.SERVER_IP }}:3001"
          echo "üìä –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ" 